{"version":3,"file":"applets-request-mode-list.min.js","sources":["../src/helpers/utils.ts","../src/ApiHttp.ts"],"sourcesContent":["/* eslint-disable guard-for-in */\n/* eslint-disable no-restricted-syntax */\nfunction getDataType(val: any): string {\n  return Object.prototype.toString.call(val);\n}\n\nexport function isArray(data: any): boolean {\n  return Array.isArray(data);\n}\n\nexport function isPlainObject(val: any): val is Record<string, any> {\n  if (val === null || getDataType(val) !== \"[object Object]\") {\n    return false;\n  }\n  const prototype = Object.getPrototypeOf(val);\n  return prototype === null || prototype === Object.prototype;\n}\n\nexport function assign<T, U>(to: T, from: U): T & U {\n  if (isString(from)) {\n    return to as T & U;\n  }\n\n  for (const key in from) {\n    (to as T & U)[key] = from[key] as any;\n  }\n\n  return to as T & U;\n}\n\nexport function isString(val: any): boolean {\n  return typeof val === \"string\";\n}\n\n/**\n * 遍历\n * @param {Object|Array} obj\n * @param fn\n */\nexport function forEach(obj: any, fn: IAppletsRequest.IEmptyFN): void {\n  if (typeof obj === \"undefined\" || obj === null) {\n    return;\n  }\n\n  let arr = obj;\n\n  // 如果obj是非object类型，例如：number，string等\n  if (typeof obj !== \"object\") {\n    arr = [obj];\n  }\n\n  if (Array.isArray(arr)) {\n    arr.forEach((item, i) => {\n      fn.call(null, item, i, obj);\n    });\n    return;\n  }\n  Object.keys(arr).forEach((key) => {\n    fn.call(null, arr[key], key, arr);\n  });\n}\n\nexport function merge(\n  ...objs: Record<string, any>[]\n): any[] | Record<string, any> {\n  if (objs.length === 0) {\n    return Object.create(null);\n  }\n\n  let result: any = Object.create(null);\n  function assignValue(val: any, key: string | number): void {\n    if (isPlainObject(result[key]) && isPlainObject(val)) {\n      result[key] = merge(result[key], val);\n    } else if (isPlainObject(val)) {\n      result[key] = merge({}, val);\n    } else if (Array.isArray(val)) {\n      result[key] = merge(val);\n    } else {\n      result[key] = val;\n    }\n  }\n\n  if (Array.isArray(objs[0])) {\n    result = [];\n  } else {\n    result = Object.create(null);\n  }\n\n  objs.forEach((obj) => {\n    forEach(obj, assignValue);\n  });\n\n  return result;\n}\n","import appletsRequest, { getDefaults } from \"applets-request-weapp\";\nimport { assign, isArray, isPlainObject, merge } from \"./helpers/utils\";\n\ninterface IApiItemConfig {\n  baseURL: string;\n  url: string;\n  fnName: string;\n  retryTimes?: number;\n  interval?: number;\n}\n\nclass ApiItem<IData = any> {\n  private hadRetry = 0;\n\n  retryTimes = 2;\n\n  interval = 2000;\n\n  baseURL = \"\";\n\n  url = \"\";\n\n  fnName = \"\";\n\n  appletsRequest: AppletsRequestInstance;\n\n  constructor(config: IApiItemConfig, request: AppletsRequestInstance) {\n    const { retryTimes, interval } = config;\n    this.baseURL = config.baseURL;\n    this.url = config.url;\n    this.fnName = config.fnName;\n    this.retryTimes = this.getValidNumber(this.retryTimes, retryTimes);\n    this.interval = this.getValidNumber(this.interval, interval);\n    this.appletsRequest = request;\n  }\n\n  getValidNumber(originalVal: number, val: number | undefined): number {\n    return !val && val !== 0 ? originalVal : val;\n  }\n\n  http(options?: IAppletsRequestConfig): IAppletsRequestPromise<IData> {\n    return new Promise((resolve, reject) => {\n      this.request(options || {}, resolve, reject);\n    });\n  }\n\n  request(\n    options: IAppletsRequestConfig,\n    resolve: any,\n    reject: IAppletsRequest.IRejected,\n  ): void {\n    Promise.resolve(options)\n      .then((reqConfig) => this.appletsRequest<IData>(reqConfig))\n      .then((res) => {\n        this.hadRetry = 0;\n        resolve(res);\n      })\n      .catch((err) => {\n        if (this.isRetryError(err) && this.hadRetry < this.retryTimes) {\n          this.hadRetry += 1;\n          const opts = merge(options, err.options || {});\n          this.request(opts, resolve, reject);\n          return;\n        }\n        if (this.isIntervalRetryError(err) && this.hadRetry < this.retryTimes) {\n          setTimeout(() => {\n            this.hadRetry += 1;\n            this.request(options, resolve, reject);\n          }, this.interval);\n          return;\n        }\n        reject(this.isRetryError(err) ? err.originalErr : err);\n      });\n  }\n\n  isRetryError(err: any): boolean {\n    if (!err) {\n      return false;\n    }\n    return err.errCode === \"RETRY_ERROR\";\n  }\n\n  isIntervalRetryError(err: any): boolean {\n    if (!err) {\n      return false;\n    }\n    return err.status === \"NETWORK_ERROR\" || err.status === \"TIMEOUT\";\n  }\n}\n\ninterface IApiHttpConfig {\n  appKey: string;\n\n  appCode: string;\n\n  baseURL: string;\n\n  apiList: { [key: string]: IApiItem } | IApiItem[];\n}\n\nexport default class ApiHttp {\n  appKey: string;\n\n  appCode: string;\n\n  baseURL: string;\n\n  apiList: { [key: string]: IApiItem };\n\n  apis: any;\n\n  appletsRequest: AppletsRequestInstance;\n\n  constructor(config: IApiHttpConfig, requestConfig?: IAppletsRequestConfig) {\n    this.apiList = {};\n    this.apis = Object.create(null);\n    this.appKey = config.appKey;\n    this.appCode = config.appCode;\n    this.baseURL = config.baseURL;\n    this.appletsRequest = appletsRequest.create(requestConfig || getDefaults());\n    this.createApiItem(config.apiList);\n  }\n\n  createApiItem(apiList: IApiItems): void {\n    if (isArray(apiList)) {\n      const tmpApiList: { [key: string]: IApiItem } = Object.create(null);\n      (apiList as IApiItem[]).forEach((item) => {\n        if (item.fnName) {\n          tmpApiList[item.fnName] = item;\n        }\n      });\n      const fnNames = (apiList as IApiItem[]).map((item) => item.fnName);\n\n      this.apiList = tmpApiList;\n      this.generateApiFn(fnNames as string[]);\n      return;\n    }\n\n    if (isPlainObject(apiList)) {\n      this.apiList = apiList as { [key: string]: IApiItem };\n\n      const fnNames = Object.keys(apiList);\n\n      this.generateApiFn(fnNames);\n    }\n  }\n\n  generateApiFn(fnNames: string[]): void {\n    fnNames.forEach((fnName) => {\n      const apiConfig = this.apiList[fnName] as IApiItem;\n      const apiItem = new ApiItem(\n        {\n          baseURL: this.baseURL,\n          fnName,\n          url: apiConfig.apiUrl,\n          interval: apiConfig.interval,\n          retryTimes: apiConfig.retryTimes,\n        },\n        this.appletsRequest,\n      );\n      this.apis[fnName] = apiItem.http.bind(apiItem);\n      this.apis[fnName] = assign(this.apis[fnName], apiItem);\n    });\n  }\n\n  createRetryError(\n    originalErr: any,\n    options?: IAppletsRequestConfig,\n  ): {\n    errCode: string;\n    originalErr: any;\n    options: IAppletsRequestConfig | undefined;\n  } {\n    return {\n      errCode: \"RETRY_ERROR\",\n      originalErr,\n      options,\n    };\n  }\n\n  addRequestInterceptor(\n    fulfilled: IAppletsRequest.IResolved<IAppletsRequestConfig>,\n    rejected?: IAppletsRequest.IRejected,\n  ): void {\n    this.appletsRequest.interceptors.request.use(fulfilled, rejected);\n  }\n\n  addResponseInterceptor<T>(\n    fulfilled: IAppletsRequest.IResolved<IAppletsRequestResponse<T>>,\n    rejected?: IAppletsRequest.IRejected,\n  ): void {\n    this.appletsRequest.interceptors.response.use(fulfilled, rejected);\n  }\n\n  createCancelToken(): IAppletsRequest.ICancelTokenInstance {\n    return new this.appletsRequest.CancelToken();\n  }\n\n  transformConfig(executor: IAppletsRequest.IConfigTransformer): void {\n    this.appletsRequest.defaults.transformConfig = executor;\n  }\n}\n"],"names":["isPlainObject","val","Object","prototype","toString","call","getDataType","getPrototypeOf","forEach","obj","fn","arr","Array","isArray","item","i","keys","key","merge","_i","objs","length","create","result","assignValue","config","request","this","retryTimes","interval","baseURL","url","fnName","getValidNumber","appletsRequest","ApiItem","originalVal","options","Promise","resolve","reject","_this","then","reqConfig","res","hadRetry","catch","err","isRetryError","opts","isIntervalRetryError","setTimeout","originalErr","errCode","status","requestConfig","apiList","apis","appKey","appCode","getDefaults","createApiItem","ApiHttp","data","tmpApiList_1","fnNames","map","generateApiFn","apiConfig","apiItem","apiUrl","http","bind","to","from","assign","fulfilled","rejected","interceptors","use","response","CancelToken","executor","defaults","transformConfig"],"mappings":"uZAUgBA,EAAcC,GAC5B,GAAY,OAARA,GAAqC,oBAT3C,SAAqBA,GACnB,OAAOC,OAAOC,UAAUC,SAASC,KAAKJ,GAQlBK,CAAYL,GAC9B,OAAO,EAET,IAAME,EAAYD,OAAOK,eAAeN,GACxC,OAAqB,OAAdE,GAAsBA,IAAcD,OAAOC,mBAwBpCK,EAAQC,EAAUC,GAChC,GAAI,MAAOD,EAAX,CAIA,IAAIE,EAAMF,EAGS,iBAARA,IACTE,EAAM,CAACF,IAGLG,MAAMC,QAAQF,GAChBA,EAAIH,SAAQ,SAACM,EAAMC,GACjBL,EAAGL,KAAK,KAAMS,EAAMC,EAAGN,MAI3BP,OAAOc,KAAKL,GAAKH,SAAQ,SAACS,GACxBP,EAAGL,KAAK,KAAMM,EAAIM,GAAMA,EAAKN,gBAIjBO,QACd,aAAAC,mBAAAA,IAAAC,kBAEA,GAAoB,IAAhBA,EAAKC,OACP,OAAOnB,OAAOoB,OAAO,MAGvB,IAAIC,EAAcrB,OAAOoB,OAAO,MAChC,SAASE,EAAYvB,EAAUgB,GACzBjB,EAAcuB,EAAON,KAASjB,EAAcC,GAC9CsB,EAAON,GAAOC,EAAMK,EAAON,GAAMhB,GACxBD,EAAcC,GACvBsB,EAAON,GAAOC,EAAM,GAAIjB,GACfW,MAAMC,QAAQZ,GACvBsB,EAAON,GAAOC,EAAMjB,GAEpBsB,EAAON,GAAOhB,EAclB,OATEsB,EADEX,MAAMC,QAAQO,EAAK,IACZ,GAEAlB,OAAOoB,OAAO,MAGzBF,EAAKZ,SAAQ,SAACC,GACZD,EAAQC,EAAKe,MAGRD,ECjFT,iBAeE,WAAYE,EAAwBC,GAd5BC,cAAW,EAEnBA,gBAAa,EAEbA,cAAW,IAEXA,aAAU,GAEVA,SAAM,GAENA,YAAS,GAKC,IAAAC,EAAyBH,aAAbI,EAAaJ,WACjCE,KAAKG,QAAUL,EAAOK,QACtBH,KAAKI,IAAMN,EAAOM,IAClBJ,KAAKK,OAASP,EAAOO,OACrBL,KAAKC,WAAaD,KAAKM,eAAeN,KAAKC,WAAYA,GACvDD,KAAKE,SAAWF,KAAKM,eAAeN,KAAKE,SAAUA,GACnDF,KAAKO,eAAiBR,EAuD1B,OApDES,2BAAA,SAAeC,EAAqBnC,GAClC,OAAQA,GAAe,IAARA,EAA0BA,EAAdmC,GAG7BD,iBAAA,SAAKE,GAAL,WACE,OAAO,IAAIC,SAAQ,SAACC,EAASC,GAC3BC,EAAKf,QAAQW,GAAW,GAAIE,EAASC,OAIzCL,oBAAA,SACEE,EACAE,EACAC,GAHF,WAKEF,QAAQC,QAAQF,GACbK,MAAK,SAACC,GAAc,OAAAF,EAAKP,eAAsBS,MAC/CD,MAAK,SAACE,GACLH,EAAKI,SAAW,EAChBN,EAAQK,MAETE,OAAM,SAACC,GACN,GAAIN,EAAKO,aAAaD,IAAQN,EAAKI,SAAWJ,EAAKb,WAAnD,CACEa,EAAKI,UAAY,EACjB,IAAMI,EAAO/B,EAAMmB,EAASU,EAAIV,SAAW,IAC3CI,EAAKf,QAAQuB,EAAMV,EAASC,QAG1BC,EAAKS,qBAAqBH,IAAQN,EAAKI,SAAWJ,EAAKb,WACzDuB,YAAW,WACTV,EAAKI,UAAY,EACjBJ,EAAKf,QAAQW,EAASE,EAASC,KAC9BC,EAAKZ,UAGVW,EAAOC,EAAKO,aAAaD,GAAOA,EAAIK,YAAcL,OAIxDZ,yBAAA,SAAaY,GACX,QAAKA,GAGkB,gBAAhBA,EAAIM,SAGblB,iCAAA,SAAqBY,GACnB,QAAKA,IAGiB,kBAAfA,EAAIO,QAA6C,YAAfP,EAAIO,2BA2B/C,WAAY7B,EAAwB8B,GAClC5B,KAAK6B,QAAU,GACf7B,KAAK8B,KAAOvD,OAAOoB,OAAO,MAC1BK,KAAK+B,OAASjC,EAAOiC,OACrB/B,KAAKgC,QAAUlC,EAAOkC,QACtBhC,KAAKG,QAAUL,EAAOK,QACtBH,KAAKO,eAAiBA,UAAeZ,OAAOiC,GAAiBK,iBAC7DjC,KAAKkC,cAAcpC,EAAO+B,SAiF9B,OA9EEM,0BAAA,SAAcN,GACZ,GDtHoBO,ECsHRP,EDrHP5C,MAAMC,QAAQkD,GCqHG,CACpB,IAAMC,EAA0C9D,OAAOoB,OAAO,MAC7DkC,EAAuBhD,SAAQ,SAACM,GAC3BA,EAAKkB,SACPgC,EAAWlD,EAAKkB,QAAUlB,MAG9B,IAAMmD,EAAWT,EAAuBU,KAAI,SAACpD,GAAS,OAAAA,EAAKkB,UAI3D,OAFAL,KAAK6B,QAAUQ,OACfrC,KAAKwC,cAAcF,ODhIDF,ECoIpB,GAAI/D,EAAcwD,GAAU,CAC1B7B,KAAK6B,QAAUA,EAETS,EAAU/D,OAAOc,KAAKwC,GAE5B7B,KAAKwC,cAAcF,KAIvBH,0BAAA,SAAcG,GAAd,WACEA,EAAQzD,SAAQ,SAACwB,GACf,IAAMoC,EAAY3B,EAAKe,QAAQxB,GACzBqC,EAAU,IAAIlC,EAClB,CACEL,QAASW,EAAKX,QACdE,SACAD,IAAKqC,EAAUE,OACfzC,SAAUuC,EAAUvC,SACpBD,WAAYwC,EAAUxC,YAExBa,EAAKP,gBAEPO,EAAKgB,KAAKzB,GAAUqC,EAAQE,KAAKC,KAAKH,GACtC5B,EAAKgB,KAAKzB,YD/IayC,EAAOC,GAClC,GAYsB,iBAZTA,EACX,OAAOD,EAGT,IAAK,IAAMxD,KAAOyD,EACfD,EAAaxD,GAAOyD,EAAKzD,GAG5B,OAAOwD,ECsIiBE,CAAOlC,EAAKgB,KAAKzB,GAASqC,OAIlDP,6BAAA,SACEV,EACAf,GAMA,MAAO,CACLgB,QAAS,cACTD,cACAf,YAIJyB,kCAAA,SACEc,EACAC,GAEAlD,KAAKO,eAAe4C,aAAapD,QAAQqD,IAAIH,EAAWC,IAG1Df,mCAAA,SACEc,EACAC,GAEAlD,KAAKO,eAAe4C,aAAaE,SAASD,IAAIH,EAAWC,IAG3Df,8BAAA,WACE,OAAO,IAAInC,KAAKO,eAAe+C,aAGjCnB,4BAAA,SAAgBoB,GACdvD,KAAKO,eAAeiD,SAASC,gBAAkBF"}